# DoReFa\PACT-QAT
Quantization (QAT) Demo on CIFAR10 
æ··åˆä½å®½é‡åŒ–ã€Quantization-aware-trainingã€MobileNetv2ã€ResNet20ã€è‡ªå®šåˆ¶çš„ConvNextNet


----

``config_train.py``: é€‰æ‹©æ¨¡å‹ã€ç½‘ç»œæ¶æ„é…ç½®ã€é‡åŒ–ä½å®½ä»¥åŠè®­ç»ƒç­–ç•¥  
``quantize_fn.py``: æƒé‡ã€æ¿€æ´»é‡åŒ–ç­–ç•¥ã€‚è¿™é‡Œå‚ç…§çš„æ˜¯[DoReFa-Net](https://arxiv.org/abs/1606.06160)ä»¥åŠ[PACT](https://arxiv.org/abs/1805.06085), å¹¶åšå‡ºäº†æ”¹è¿›  
``QConvnextblock.py``: åŸºç¡€çš„block  
``ToyNet.py\MobileNetv2.py``: å®šä¹‰äº†å¾…é‡åŒ–çš„æ¨¡å‹ ,stem + multiple blocks + heard + fcå®æ¶æ„, ToyNetä¸­å¯ç”¨PACTè®­ç»ƒ  
``ResNet_CF``: å®šä¹‰äº†ResNet20åœ¨Cifar10ä¸Šçš„é‡åŒ–æ¨¡å‹ï¼ŒDoReFaé‡åŒ–     
``train.py``:  è®­ç»ƒæ–‡ä»¶  
## æ€»ç»“
ä»¥å¾€è½¯ä»¶é‡åŒ–ä»…ä»…åœ¨convã€fcçš„è¾“å…¥ã€è¾“å‡ºé‡åŒ–ï¼Œè¿™é‡Œblockçš„è¾“å…¥ã€è¾“å‡ºéƒ½ç»è¿‡äº†ä¼ªé‡åŒ–(è¯¥æ“ä½œå¯¹ç²¾åº¦ä¼šæœ‰å½±å“ï¼Œå°¤å…¶æ˜¯MBConv)   
ResNetç±»ç½‘ç»œç›´æ¥ä½¿ç”¨DoReFaé‡åŒ–å¯¹ç²¾åº¦å½±å“ä¸å¤§ã€‚ä½†MBConvç±»åˆ™æ•ˆæœä¸è¡ŒINT8 QATä¸‹é™éƒ½æ˜æ˜¾ï¼Œå…³é”®åœ¨äºDoReFaå¯¹æ¿€æ´»çš„æˆªå–ã€‚  
è®­ç»ƒè¶…å‚æ•°å¯¹æœ€ç»ˆç²¾åº¦å½±å“ä¹Ÿå¾ˆå¤§ï¼Œä»å¤´è®­ç»ƒå¯èƒ½ä¸å¦‚å¦‚å°batchå¾®è°ƒ100 epoch

## é‡åŒ–é€‰æ‹©
:gift_heart:  blockå†…æœ€åä¸€ä¸ªconvå±‚æ¿€æ´»é‡åŒ–æ”¾ç½®åœ¨"+="ä¹‹åï¼Œåˆ†æ”¯å¦‚æœ‰convæ“ä½œåˆ™å¯¹è¾“å‡ºè¿›è¡Œä¼ªé‡åŒ–  
:black_heart: BNå±‚ä¸folding(qatæ—¶å¯¹ç²¾åº¦å½±å“è¾ƒå¤§ï¼Œå®¹æ˜“ä¸æ”¶æ•›)ï¼ŒBNå±‚çš„weightã€biasé€šè¿‡INT32å®šç‚¹æ•°è¿‘ä¼¼  
:black_heart: å€Ÿé‰´PACTå¯¹æ¿€æ´»ç¼©æ”¾åæˆªæ–­å†æ‰©æ”¾ï¼Œscaleè®¾ç½®ä¸ºå®šå€¼å¯¹MBConvæœ‰æ•ˆ

- [x] æ¯ä¸ªblockå†…éƒ¨çš„æ¿€æ´»å’Œæƒé‡ä½å®½ç›¸åŒ
- [x] é¦–å°¾ä¸¤å±‚(è¾“å…¥å±‚ã€FCå±‚)æ•æ„Ÿåº¦å¾ˆé«˜(å°¤å…¶æ˜¯æ¿€æ´»)
- [x] å¹³å‡æ± åŒ–ä¸BNå±‚çš„é‡åŒ–16bitæ—¶å¯¹ç²¾åº¦å½±å“ä¸å¤§

## å®éªŒè®°å½•
ğŸ˜ ToyNet  
batch=128, lr=0.01, 'cos'å­¦ä¹ ç‡è°ƒæ•´, epoch=300 (params:0.203626M, MADDS :25.601536M)   
```cfg-1*```:è¾“å…¥ä¸é‡åŒ–ï¼Œfcæ¿€æ´»16bit(F32,L16)ï¼Œå…¶ä½™å‡INT8  
|ToyNet|full Precision| cfg-1 w\o larger Batchsize|cfg-2 w\o modified pact|cfg-1* + mPACT |cfg-3 + mpact|
|:--:| :--:|:--:|:--:|:--:|:--:|
|ACC(%) |91.594 |89.814\89.482|91.317\89.458 |**91.416**|90.813|

```bit=32```æ„å‘³ç€ä¸é‡åŒ–,avgpoolingçš„è¾“å‡ºé‡åŒ–ç­–ç•¥ä¸``fc``çš„``a_bit``ç›¸åŒ(é»˜è®¤é‡åŒ–)  
å‚æ•°ï¼šstem(1)+blocks(1,3,3,3)+hearder(1)+fc(1)  

cfg-1:  
```python
C.layer_abit = [32,  8, 8,8,8, 8,8,8, 8,8,8,  32,32]
C.layer_wbit = [32,  8, 8,8,8, 8,8,8, 8,8,8,  16,16]
```
cfg-2:  
```python
C.layer_abit = [32,8, 8,8,8, 8,8,8, 8,8,8, 32,32]
C.layer_wbit = [32,8, 6,6,6, 6,6,6, 8,8,8, 16,16]
```
cfg-3:  
```python
C.layer_abit = [32,8, 6,6,6, 6,6,6, 6,6,6, 32,32]
C.layer_wbit = [32,8, 6,6,6, 6,6,6, 6,6,6, 16,16]
```
----
ğŸ˜ MobileNetv2  
è®­ç»ƒå‚æ•°ä¸å˜ï¼ŒMEMï¼š2.383050M, MADDS = 98.645504M   
``cfg-1*``:stem+head+fcçš„ä½å®½ç›¸åŒï¼Œä¸­é—´å±‚å‡INT8; ``cfg-2*``ç±»ä¼¼è°ƒæ•´äº†éƒ¨åˆ†åç«¯çš„blockä½å®½   
|MBv2 |full Precision| cfg-1* w\o pact |cfg*-1 + mPACT| cfg-2*|
|:--:| :--:|:--:|:--:|:--:|
|ACC(%) |94.165 |88.983\81.665|93.084|xx|


----
:rocket:ResNet20   
QATå‚æ•°å˜ä¸ºbatch:256, lr:0.1. MEM:0.272474M, MADDS = 41.214656M    
è¿™é‡Œä»…ä»…DoReFaï¼Œæ•ˆæœå°±ä¸é”™äº†ä¸è¿‡ã€‚**è®­ç»ƒå‚æ•°éœ€è°ƒæ•´```90.477->92.021```**
|ResNet20 |full Precision| cfg-1* w\o branch_out quant | cfg-2*|
|:--:| :--:|:--:|:--:|
|ACC(%) |92.50 |92.021\92.344|xx|
## TODO
- [ ] æ•´å‹æ¨ç†
- [ ] æƒé‡æå–
- [ ] ç¡¬ä»¶ä»¿çœŸ
